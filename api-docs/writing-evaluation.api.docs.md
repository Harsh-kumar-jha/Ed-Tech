# Writing Evaluation API Documentation

## Overview

The Writing Evaluation API provides endpoints for IELTS writing test evaluation. Task 1 prompts are randomly selected from a pre-defined template database managed by administrators. Task 2 is generated by AI while the user works on Task 1.

## Authentication

All endpoints require JWT authentication. Include the JWT token in the Authorization header:
```
Authorization: Bearer <your_jwt_token>
```

## Endpoints

### 1. Start Writing Test

Initiates a new writing test session. Returns a random Task 1 from the template database and starts asynchronous Task 2 generation.

**Endpoint:** `POST /api/writing/start`

**Request Body:**
```json
{
  "test_type": "academic" | "general_training"
}
```

**Response:**
```json
{
  "testSessionId": "WT-1234567890-user123",
  "task1Prompt": "The graph shows...",
  "task1ImageUrl": "./Assets/chart1.jpg",
  "timeLimit": 1200 // 20 minutes in seconds
}
```

### 2. Submit Task 1

Submits and evaluates Task 1 response. Returns Task 2 prompt (which was generated while user worked on Task 1).

**Endpoint:** `POST /api/writing/evaluate/task1`

**Request Body:**
```json
{
  "test_session_id": "WT-1234567890-user123",
  "user_response": "string",
  "word_count": 150,
  "time_taken": 1200
}
```

**Response:**
```json
{
  "evaluation": {
    "overall_band": 7.0,
    "detailed_feedback": {
      "task_achievement": { "score": 7.0, "comments": "..." },
      "coherence_cohesion": { "score": 7.0, "comments": "..." },
      "lexical_resource": { "score": 7.0, "comments": "..." },
      "grammatical_range": { "score": 7.0, "comments": "..." }
    }
  },
  "task2Prompt": "Some people think...",
  "timeLimit": 2400 // 40 minutes in seconds
}
```

### 3. Submit Task 2

Submits and evaluates Task 2 response, returns combined evaluation.

**Endpoint:** `POST /api/writing/evaluate/task2`

**Request Body:**
```json
{
  "test_session_id": "WT-1234567890-user123",
  "user_response": "string",
  "word_count": 250,
  "time_taken": 2400
}
```

**Response:**
```json
{
  "task2Evaluation": {
    "overall_band": 7.0,
    "detailed_feedback": {
      "task_achievement": { "score": 7.0, "comments": "..." },
      "coherence_cohesion": { "score": 7.0, "comments": "..." },
      "lexical_resource": { "score": 7.0, "comments": "..." },
      "grammatical_range": { "score": 7.0, "comments": "..." }
    }
  },
  "combinedBand": 7.0,
  "overallFeedback": {
    "strengths": ["..."],
    "areas_for_improvement": ["..."],
    "recommendations": ["..."]
  },
  "progressAnalysis": {
    "testCount": 5,
    "averageBand": 6.5,
    "bestBand": 7.0,
    "trend": "improving",
    "detailed_analysis": "..."
  }
}
```

### 4. Task 1 Template Management (Admin Only)

#### Create Template

Creates a new Task 1 template.

**Endpoint:** `POST /api/writing/templates/task1`

**Request Body:**
```json
{
  "type": "Bar chart",
  "prompt": "The chart shows...",
  "image_url": "./Assets/chart1.jpg"
}
```

**Response:**
```json
{
  "message": "Template created successfully",
  "template": {
    "id": "template123",
    "type": "Bar chart",
    "prompt": "The chart shows...",
    "imageUrl": "./Assets/chart1.jpg",
    "createdAt": "2024-07-03T14:05:32Z",
    "updatedAt": "2024-07-03T14:05:32Z",
    "createdBy": "admin123",
    "isActive": true
  }
}
```

#### Get Templates

Retrieves Task 1 templates with optional filters.

**Endpoint:** `GET /api/writing/templates/task1`

**Query Parameters:**
- `type`: Filter by template type (optional)
- `active_only`: Show only active templates (optional, boolean)

**Response:**
```json
{
  "templates": [
    {
      "id": "template123",
      "type": "Bar chart",
      "prompt": "The chart shows...",
      "imageUrl": "./Assets/chart1.jpg",
      "createdAt": "2024-07-03T14:05:32Z",
      "updatedAt": "2024-07-03T14:05:32Z",
      "createdBy": "admin123",
      "isActive": true
    }
  ]
}
```

#### Update Template

Updates an existing Task 1 template.

**Endpoint:** `PUT /api/writing/templates/task1/:id`

**Request Body:**
```json
{
  "type": "Bar chart",
  "prompt": "Updated prompt...",
  "image_url": "./Assets/updated-chart.jpg",
  "is_active": true
}
```

**Response:**
```json
{
  "message": "Template updated successfully",
  "template": {
    "id": "template123",
    "type": "Bar chart",
    "prompt": "Updated prompt...",
    "imageUrl": "./Assets/updated-chart.jpg",
    "createdAt": "2024-07-03T14:05:32Z",
    "updatedAt": "2024-07-03T14:05:32Z",
    "createdBy": "admin123",
    "isActive": true
  }
}
```

#### Delete Template

Deletes a Task 1 template.

**Endpoint:** `DELETE /api/writing/templates/task1/:id`

**Response:**
```json
{
  "message": "Template deleted successfully"
}
```

## Error Responses

All endpoints may return the following error responses:

```json
{
  "error": "Error message",
  "status": "error_code"
}
```

Common error codes:
- 400: Bad Request (missing or invalid parameters)
- 401: Unauthorized (invalid or missing token)
- 403: Forbidden (insufficient permissions)
- 404: Not Found
- 500: Internal Server Error

## Task Flow

1. Task 1:
   - Randomly selected from admin-managed template database
   - Includes prompt text and associated image
   - 20-minute time limit
   - Task 2 is generated asynchronously during this time

2. Task 2:
   - Generated by AI while user works on Task 1
   - Available immediately after Task 1 submission
   - 40-minute time limit
   - If generation fails during Task 1, generated on-demand at Task 1 submission

## Data Retention

- Questions and responses are stored for 24 hours
- Feedback and band scores are stored permanently
- Progress analysis is available for users with 5+ completed tests

## Band Score Calculation

- Task 1: 1/3 of total score
- Task 2: 2/3 of total score
- Combined score rounded to nearest 0.5

## Word Count Requirements

- Task 1: Minimum 150 words
- Task 2: Minimum 250 words
- Penalty applied for submissions below minimum (-0.5 bands)

## Time Limits

- Task 1: 20 minutes
- Task 2: 40 minutes
- Time tracking is informative only (no penalties) 